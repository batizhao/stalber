<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="me.batizhao.app.mapper.AppTableMapper">

  <resultMap id="appTableMap" type="me.batizhao.app.domain.AppTable">
    <id property="id" column="id"/>
    <result property="appId" column="appId"/>
    <result property="dsName" column="dsName"/>
    <result property="tableName" column="tableName"/>
    <result property="tableComment" column="tableComment"/>
    <result property="columnMetadata" column="columnMetadata"/>
    <result property="codeMetadata" column="codeMetadata"/>
    <result property="createTime" column="createTime"/>
    <result property="updateTime" column="updateTime"/>
  </resultMap>

  <resultMap id="appTableColumnMap" type="me.batizhao.app.domain.AppTableColumn">
    <result property="name" column="name"/>
    <result property="comment" column="comment"/>
    <result property="type" column="type"/>
    <result property="length" column="length"/>
    <result property="decimal" column="decimal"/>
    <result property="primary" column="primaryKey"/>
    <result property="increment" column="increment"/>
    <result property="required" column="required"/>
    <result property="defaultValue" column="defaultValue"/>
    <result property="javaType" column="javaType"/>
    <result property="javaField" column="javaField"/>
  </resultMap>

  <select id="selectTablePageByDs" resultMap="appTableMap">
    select table_name tableName, engine engine, table_comment tableComment, create_time createTime, update_time updateTime from information_schema.tables
    where table_schema = (select database())
    and table_name != 'DATABASECHANGELOG' and table_name != 'DATABASECHANGELOGLOCK' and table_name != 'undo_log'
    <if test="appTable.tableName != null and appTable.tableName.trim() != ''">
      and table_name like concat('%', #{appTable.tableName}, '%')
    </if>
    <if test="appTable.tableComment != null and appTable.tableComment.trim() != ''">
      and table_comment like concat('%', #{appTable.tableComment}, '%')
    </if>
    order by update_time desc
  </select>

  <select id="selectColumnsByTableName" resultMap="appTableColumnMap">
    select column_name as name,
           (case when (is_nullable = 'no' <![CDATA[ && ]]> column_key != 'PRI') then '1' else '0' end) as required,
           (case when column_key = 'PRI' then '1' else '0' end) as primaryKey,
           ordinal_position as sort,
           column_comment as comment,
           (case when extra = 'auto_increment' then '1' else '0' end) as increment,
           data_type as type,
           character_maximum_length as length,
           column_default as defaultValue
    from information_schema.columns
    where table_schema = (select database()) and table_name = #{tableName}
    order by ordinal_position
  </select>

</mapper>
